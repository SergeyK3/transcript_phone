# Техническое задание (ТЗ)

## Цель
Разработать серверное приложение (бот) для экзаменов, принимающее голосовые ответы экзаменуемых в Telegram, транскрибирующее их через OpenAI Whisper API, при необходимости переводя с казахского на русский, сопоставляющее полученные ответы с эталонными из базы и выдающее предварительную оценку. Система должна поддерживать несколько дисциплин и наборов вопросов (билетов).

## Требования функциональные

1. Telegram-интеграция
   - Приём сообщений через webhook.
   - Поддержка voice (ogg/opus), audio (mp3) и document (audio/*).
   - Команды для управления дисциплинами: /disciplines, /setdiscipline <id>, /currentdiscipline, /start, /help.

2. Транскрипция
   - Использовать OpenAI Whisper API (model=whisper-1).
   - Конвертация аудио (ffmpeg) к рекомендуемому формату (опция).
   - Таймауты и retry при общении с OpenAI.
   - Сохранение raw и нормализованного транскрипта локально.

3. Перевод
   - Опция переводить транскрипты KZ→RU (через OpenAI text API или встроенную опцию).
   - Хранение как оригинального текста, так и перевода.

4. Хранение данных
   - Локальное файловое хранилище: uploads/, transcripts/.
   - Реляционная БД (SQLite/Postgres) с таблицами:
     - disciplines, questions (bilet), chat_settings, submissions.
   - Поля субмишн: user_id, chat_id, question_id, audio_path, transcript_raw, transcript_norm, translated_text, score, details, created_at.

5. Оценка/сравнение
   - Нормализация текстов (lowercase, punctuation, whitespace).
   - Семантическая оценка: эмбеддинги + косинусное сходство (OpenAI Embeddings).
   - Параллельно — проверка наличия required keywords и n-gram метрика (ROUGE/BLEU).
   - Формула агрегирования скор: configurable weights (по умолчанию: 0.6 семантика, 0.3 ключи, 0.1 n-gram).
   - Сохранение деталей оценки в submissions.details.

6. Админка / API
   - REST API (FastAPI) для CRUD дисциплин и вопросов (/admin/*).
   - Endpoint для импорта из Google Sheets и/или из n8n JSON.
   - Endpoint для запуска повторной оценки/проверки submission.

7. Безопасность и конфиденциальность
   - Хранение ключей в .env / secrets manager.
   - Конфигурация по согласованию: возможность локальной обработки (альтернатива облаку) при требовании приватности.

8. Логирование и мониторинг
   - Логи обработки аудио, ошибок API, статистика по длительности транскрипций, ошибки ASR.
   - Уведомления в Telegram о критических ошибках (опция).

## Нефункциональные требования
- Развёртывание: Dockerfile и инструкциеи для локального запуска + ngrok рекомендации.
- Тесты: unit-тесты для scoring, интеграционные тесты для flow webhook → transcript.
- Масштабируемость: очереди/worker (Redis + RQ/Celery) — в roadmap.
- Производительность: предусмотреть лимит размера аудио (рекомендация: до 5–10 минут).

## Интерфейсы
- Telegram webhook: POST /telegram/webhook
- Админ API: /admin/disciplines, /admin/questions, /admin/import

## Приоритеты первого этапа (MVP)
1. Приём аудио, сохранение, транскрипция через OpenAI Whisper API, отправка результата в чат и сохранение транскрипта в БД.
2. Поддержка дисциплин и билетов, команды Telegram для выбора дисциплины.
3. Scoring: семантическая оценка через OpenAI embeddings + required keywords.
4. Скрипт импорта из Google Sheets (Voprosi/Otveti).
5. Документация и инструкции по запуску.

## Ограничения
- Пользовательские ключи OpenAI и Telegram не должны попадать в репозиторий.
- Для экзаменов с высокой конфиденциальностью — предусмотреть альтернативу локального ASR (future).